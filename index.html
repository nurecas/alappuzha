<html>

<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.3.1/p5.min.js"></script>
    <script src="beach.js"></script>
    <script src="lake.js"></script>
    <script src="mullakkal.js"></script>
    <script src="lighthouse.js"></script>
    <script src="fields.js"></script>
    <script src="extraClasses.js"></script>
</head>

<body>
    <script>
        let seed = 477;
        let R;
        let tod = 0;
        let loca = "",
            prevLocation = ".",
            inAlappuzha = false;
        let beach, lake, mullakkal, lighthouse, fields, kathakali;
        let treeNum, treeNumRand, horizBoatRand, boat = false,
            fieldNum, houseBoatRand, houseBoat = false,
            shopNum, thoranamRand, thoranam = false,
            birds = false,
            lightRand, birdsRand, lightHouseLight = false,
            irrigationNum, fieldType, storkRand, stork = false,
            geoOn = false;
        let rainfall = [];
        let raining = false;
        let theme = 0;
        let gradientSky = false;
        let rainbow = false;
        p5.disableFriendlyErrors = true;

        function setup() {
            var cnv;
            if (windowWidth >= windowHeight)
                cnv = createCanvas(windowHeight, windowHeight);
            else
                cnv = createCanvas(windowWidth, windowWidth);
            cnv.style('display', 'block');
            let seed = random(0, 10000);
            R = new Random(seed);
            var gradSkyRand = random(0, 1);
            var rainbowRand = random(0, 1000);
            horizBoatRand = random(0, 1);
            treeNumRand = floor(random(0, 3));
            houseBoatRand = random(0, 1);
            fieldNum = floor(random(0, 3));
            thoranamRand = random(0, 1);
            shopNum = floor(random(0, 3));
            birdsRand = random(0, 1);
            lightRand = random(0, 1);
            irrigationNum = floor(random(0, 3));
            storkRand = random(0, 1);
            theme = floor(random(0, 4));
            if (gradSkyRand < 0.5) {
                gradientSky = true;
            } else {
                gradientSky = false;
            }
            if (rainbowRand < 25) {
                rainbow = true;
            } else {
                rainbow = false;
            }
            rainfall = new Rain(R, tod);
            getCurrentLocation();
            setInterval(function() {
                getCurrentLocation();
            }, 5000);
            rainfallCheck();
            setInterval(function() {
                rainfallCheck();
            }, 15000);
            document.body.style.backgroundColor = "#000000";
            document.body.style.margin = 0;
            document.body.style.display = "flex";
            document.body.style.justifyContent = "center";
            document.body.style.alignItems = "center";
        }

        function windowResized() {
            if (windowWidth >= windowHeight) {
                resizeCanvas(windowHeight, windowHeight);
            } else {
                resizeCanvas(windowWidth, windowWidth);
            }
            if (raining) {
                rainfall.resize();
            }
        }

        function draw() {
            background(0);
            let h = hour();
            if (h > 6 && h < 17) {
                tod = 0;
            } else if (h >= 17 && h < 19) {
                tod = 1;
            } else {
                tod = 2;
            }

            if (loca != prevLocation) {
                beach = new Beach(R, tod);
                lake = [];
                mullakkal = [];
                lighthouse = [];
                fields = [];
                kathakali = [];
                if (loca == "Beach") {
                    if (horizBoatRand > 0.6) {
                        boat = true;
                    } else {
                        boat = false;
                    }
                    treeNum = treeNumRand;
                } else if (loca == "Lake") {
                    if (houseBoatRand > 0.6) {
                        houseBoat = true;
                    } else {
                        houseBoat = false;
                    }
                    lake = new Lake(R, tod);
                } else if (loca == "Mullakkal") {
                    if (thoranamRand > 0.6) {
                        thoranam = true;
                    } else {
                        thoranam = false;
                    }
                    mullakkal = new Mullakkal(R, tod);
                } else if (loca == "Lighthouse") {
                    lighthouse = new Lighthouse(R, tod);
                    if (birdsRand > 0.6) {
                        birds = true;
                    } else {
                        birds = false;
                    }
                    if (lightRand > 0.6) {
                        lightHouseLight = true;
                    } else {
                        lightHouseLight = false;
                    }
                    lighthouse = new Lighthouse(R, tod);
                } else if (loca == "Fields") {
                    if (storkRand > 0.6) {
                        stork = true;
                    } else {
                        stork = false;
                    }
                    if (month() >= 10 && month() <= 3) {
                        fieldType = 0;
                    } else {
                        fieldType = 1;
                    }
                    fields = new Fields(R, tod);
                } else {
                    kathakali = new Kathakali();
                }
            }
            if (loca == "Beach") {
                beach.drawSky(gradientSky);
                beach.drawSun(rainbow);
                beach.drawBoat(boat);
                beach.drawOcean();
                beach.drawSand();
                beach.drawTrees(treeNum);
            } else if (loca == "Lake") {
                beach.drawSky(gradientSky);
                beach.drawSun(rainbow);
                lake.drawFields(fieldNum);
                lake.drawHouseboat(houseBoat);
                lake.drawWaves();
                lake.drawVallom();
            } else if (loca == "Mullakkal") {
                beach.drawSky(gradientSky);
                beach.drawSun(rainbow);
                mullakkal.drawGopuram();
                mullakkal.drawThoranam(thoranam);
                mullakkal.drawShop(shopNum, raining);
                mullakkal.drawPeople(raining);
            } else if (loca == "Lighthouse") {
                beach.drawSky(gradientSky);
                beach.drawSun(rainbow);
                lighthouse.drawBirds(birds);
                lighthouse.drawOcean();
                lighthouse.drawIsland();
                lighthouse.drawLighthouse(lightHouseLight);
            } else if (loca == "Fields") {
                beach.drawSky(gradientSky);
                beach.drawSun(rainbow);
                fields.drawBackwater();
                fields.drawField(irrigationNum, fieldType);
                fields.drawBorderGreen();
                fields.drawStork(stork);
            } else {
                beach.drawSky(gradientSky);
                beach.drawSun(rainbow);
                kathakali.drawKathakali();
            }
            prevLocation = loca;
            if (raining) {
                rainfall.drop();
                rainfall.dis();
            }
            noFill();
            stroke(0);
            strokeWeight(width);
            ellipse(width / 2, height / 2, 1.7 * width, 1.7 * height);
        }

        function rainfallCheck() {
            let url = "https://api.openweathermap.org/data/2.5/weather?q=Alappuzha&appid=4543264c57f42c3a0f35b331602aef8b";
            if (inAlappuzha) {
                loadJSON(url, rains, error);
            }
        }

        function rains(rain) {
            if (rain.weather[0].main == "Rain") {
                raining = true;
            } else {
                raining = false;
            }
        }

        function error(err) {
            console.log(err);
        }

        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition);
            } else {
                alert("Geolocation is not supported by this browser.");
                loca = "";
            }
        }

        function showPosition(position) {
            var currLat = position.coords.latitude;
            var currLong = position.coords.longitude;
            console.log("Current Latitude=" + currLat + " and Current Longitude=" + currLong);
            inAlappuzha = true;
            if (distance(currLat, currLong, 9.492503389009197, 76.31606159579695) < 0.3) {
                loca = "Beach";
            } else if (distance(currLat, currLong, 9.503474971808359, 76.3550144919712) < 0.6) {
                loca = "Lake";
            } else if (distance(currLat, currLong, 9.497514066705328, 76.34331532077417) < 0.8) {
                loca = "Mullakkal";
            } else if (distance(currLat, currLong, 9.494058721722167, 76.32099238309455) < 0.05) {
                loca = "Lighthouse";
            } else if (distance(currLat, currLong, 9.428890667162333, 76.44494531366423) < 5) {
                loca = "Fields";
            } else {
                inAlappuzha = false;
                loca = "";
            }
        }

        function distance(lat1, lon1, lat2, lon2) {
            var R = 6371;
            var dLat = (lat2 - lat1).toRad();
            var dLon = (lon2 - lon1).toRad();
            var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1.toRad()) * Math.cos(lat2.toRad()) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            var d = R * c;
            return d;
        }
        if (typeof(Number.prototype.toRad) === "undefined") {
            Number.prototype.toRad = function() {
                return this * Math.PI / 180;
            }
        }

    </script>
</body>

</html>
